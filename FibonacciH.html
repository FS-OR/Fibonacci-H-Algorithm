<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fibonacci H Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    label { display: block; margin-top: 10px; }
    input, button, textarea { margin-top: 5px; padding: 6px; width: 100%; }
    #output { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Fibonacci H Tokenizer</h1>

  <label>Input text:</label>
  <input id="inputText" placeholder="ex: Popescu Ion|1975|ID12345">

  <label>Optional password (for AES-GCM encryption):</label>
  <input id="password" type="password">

  <button id="btnGenerate">Generate token</button>
  <button id="btnSave">Save mapping (JSON)</button>
  <button id="btnLoad">Load mapping (JSON)</button>

  <div id="output"></div>

  <script>
    // --- SHA256 digest (hex) ---
    async function sha256Hex(str) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
      return Array.from(new Uint8Array(buf))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    }

    // --- simple hex->letters mapping ---
    const HEX_TO_LETTER = {
      '0':'a','1':'e','2':'i','3':'o','4':'u','5':'b',
      '6':'c','7':'d','8':'l','9':'m','a':'n','b':'p',
      'c':'r','d':'s','e':'t','f':'v'
    };
    function isVowel(ch){ return ['a','e','i','o','u'].includes(ch); }
    function buildLetterLists(hexStr){
      const letters = Array.from(hexStr).map(h => HEX_TO_LETTER[h] || 'a');
      const vowels = letters.filter(isVowel);
      const consonants = letters.filter(ch => !isVowel(ch));
      while(vowels.length<21) vowels.push('a');
      while(consonants.length<13) consonants.push('x');
      return {vowels, consonants};
    }
    function findTwoDigits(hexStr){
      for(let i=0;i<hexStr.length-1;i++){
        const a=hexStr[i], b=hexStr[i+1];
        if(/[0-9]/.test(a) && /[0-9]/.test(b)) return a+b;
      }
      return '00';
    }
    function composeTokenFromHex(hexStr){
      const {vowels, consonants} = buildLetterLists(hexStr);
      const name = (consonants[0]+vowels[0]+consonants[1]+vowels[2])
        .replace(/^\w/, c=>c.toUpperCase());
      const surname = (consonants[4]+vowels[7]+consonants[12]+vowels[20])
        .replace(/^\w/, c=>c.toUpperCase());
      const year = findTwoDigits(hexStr);
      return `${name} ${surname} ${year}`;
    }

    // --- AES-GCM helpers ---
    async function getKey(password, salt){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {name:"PBKDF2", salt:enc.encode(salt), iterations:100000, hash:"SHA-256"},
        keyMaterial, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]
      );
    }
    async function encrypt(text, password){
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKey(password,"fibosalt");
      const enc = new TextEncoder().encode(text);
      const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, enc);
      return {iv:Array.from(iv), data:Array.from(new Uint8Array(cipher))};
    }
    async function decrypt(payload, password){
      const iv = new Uint8Array(payload.iv);
      const data = new Uint8Array(payload.data);
      const key = await getKey(password,"fibosalt");
      const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, data);
      return new TextDecoder().decode(plain);
    }

    // --- Main ---
    document.getElementById("btnGenerate").addEventListener("click", async ()=>{
      const text = document.getElementById("inputText").value.trim();
      if(!text){ alert("Enter some input text"); return; }

      const hex = await sha256Hex(text);
      const token = composeTokenFromHex(hex);

      let outputText = "SHA-256 checksum: " + hex + "\n" +
                       "Fibonacci H token: " + token;

      const password = document.getElementById("password").value;
      if(password){
        const encrypted = await encrypt(text, password);
        outputText += "\nEncrypted mapping (JSON):\n" + JSON.stringify(encrypted);
      }

      document.getElementById("output").textContent = outputText;
    });

    document.getElementById("btnSave").addEventListener("click", async ()=>{
      const text = document.getElementById("inputText").value.trim();
      if(!text){ alert("No input"); return; }
      const password = document.getElementById("password").value || "default";
      const encrypted = await encrypt(text,password);
      const blob = new Blob([JSON.stringify(encrypted)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "fib_mapping.json";
      a.click();
    });

    document.getElementById("btnLoad").addEventListener("click", ()=>{
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async e=>{
        const file = e.target.files[0];
        const text = await file.text();
        const payload = JSON.parse(text);
        const password = prompt("Enter password for decryption:");
        try {
          const plain = await decrypt(payload,password);
          alert("Recovered text: " + plain);
        } catch(err){
          alert("Decryption failed: " + err);
        }
      };
      input.click();
    });
  </script>
</body>
</html>
